# 3D抽奖系统原型报告

## 文档信息

**项目名称：** 3D抽奖系统  
**文档类型：** 系统原型报告  
**版本号：** v1.0  
**编写日期：** 2025年12月  
**编写人员：** 陈科，王凯杰，唐琬芸



## 目录

1. [项目概述](#1-项目概述)
2. [需求回顾](#2-需求回顾)
3. [系统架构设计](#3-系统架构设计)
4. [功能模块详细设计](#4-功能模块详细设计)
5. [界面原型说明](#5-界面原型说明)
6. [交互流程设计](#6-交互流程设计)
7. [数据模型设计](#7-数据模型设计)
8. [技术实现方案](#8-技术实现方案)
9. [系统特色功能](#9-系统特色功能)
10. [部署与运行方案](#10-部署与运行方案)



## 1. 项目概述

### 1.1 项目背景

3D抽奖系统是一个基于Web技术的现代化抽奖平台，主要应用于企业年会、活动抽奖等场景。系统采用前后端分离架构，提供3D可视化抽奖体验，支持Excel数据导入导出、语音控制、实时同步等高级功能。

### 1.2 项目目标

- 提供沉浸式的3D抽奖视觉体验
- 支持灵活的奖项和人员配置管理
- 实现高效的抽奖流程控制
- 提供完善的抽奖结果记录和导出功能
- 支持多种交互方式（鼠标、键盘、语音）

### 1.3 核心价值

- **视觉体验**：基于Three.js的3D粒子系统，提供震撼的视觉体验
- **操作便捷**：支持Excel批量导入、一键配置、语音控制
- **功能完善**：涵盖抽奖全流程，从配置到结果导出
- **技术先进**：采用Vue 3、TypeScript、WebSocket等现代技术栈



## 2. 需求回顾

### 2.1 功能需求

根据软件需求说明报告，系统需要实现以下核心功能：

#### 2.1.1 用户认证与权限管理
- 登录界面，默认密码验证（密码：123）
- 登录后进入抽奖主界面
- 预留多权限系统扩展接口

#### 2.1.2 参与人员管理
- Excel模板下载（包含姓名、二级部门、三级部门字段）
- Excel文件上传，支持格式校验
- 参与人员列表查看和管理
- 支持权重设置（重复出现增加中奖概率）
- 中奖名单查看和导出

#### 2.1.3 奖项与奖品配置
- 奖项列表管理（创建、编辑、删除）
- 每个奖项可设置：
  - 奖项名称（如：一等奖、二等奖）
  - 奖品名称（如：iPhone 15、U盘）
  - 奖品数量
  - 奖品缩略图
  - 单次抽取人数
  - 分批抽取配置
- 支持初始化默认奖项

#### 2.1.4 3D抽奖主界面
- 3D粒子系统展示所有参与者
- 参与者标签卡片环绕球体布局
- 鼠标交互控制（拖拽旋转、滚轮缩放、双击重置）
- 两阶段抽奖流程：
  - 第一阶段：开始旋转动画，播放抽奖音乐1
  - 第二阶段：停止旋转，抽取中奖者，播放抽奖音乐2
- 中奖者飞出高亮展示

#### 2.1.5 系统配置
- 系统标题自定义
- 背景图片上传和管理
- 背景音乐配置（循环播放）
- 抽奖音乐配置（音乐1：开始音效，音乐2：中奖音效）
- 音量调节
- 标签样式配置（背景色、文字色、透明度）

#### 2.1.6 抽奖结果管理
- 实时显示中奖信息
- 中奖名单查询
- Excel格式导出中奖结果

#### 2.1.7 语音识别与控制
- 唤醒词检测（"小羊小羊"、"你好小羊"）
- 语音指令识别（开始抽奖、停止抽奖、查询结果等）
- 意图识别与执行
- 语音播报中奖结果

### 2.2 非功能需求

- **性能要求**：支持1000+参与者的流畅3D渲染
- **兼容性**：支持Chrome 90+、Firefox 88+、Safari 14+、Edge 90+
- **响应式**：支持不同屏幕尺寸的自适应显示
- **实时性**：WebSocket实时同步，多客户端同步抽奖状态



## 3. 系统架构设计

### 3.1 总体架构

系统采用前后端分离架构，具体如下：

```
┌─────────────────────────────────────────────────────────┐
│                      客户端层                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │   Web浏览器   │  │   Web浏览器   │  │   Web浏览器   │ │
│  └──────────────┘  └──────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────┘
                        ↕ HTTP/WebSocket
┌─────────────────────────────────────────────────────────┐
│                      前端应用层                          │
│  ┌──────────────────────────────────────────────────┐  │
│  │  Vue 3 + TypeScript + Vite                       │  │
│  │  - 3D渲染（Three.js）                            │  │
│  │  - 状态管理（Pinia）                             │  │
│  │  - UI组件（Element Plus）                       │  │
│  │  - 语音识别（Web Speech API）                    │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                        ↕ REST API / WebSocket
┌─────────────────────────────────────────────────────────┐
│                      后端服务层                          │
│  ┌──────────────────────────────────────────────────┐  │
│  │  Node.js + Express + TypeScript                 │  │
│  │  - RESTful API                                   │  │
│  │  - WebSocket服务器                              │  │
│  │  - 文件上传处理（Multer）                        │  │
│  │  - 语音识别服务（ASR SDK）                      │  │
│  │  - 文本转语音（TTS）                             │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                        ↕
┌─────────────────────────────────────────────────────────┐
│                      数据持久层                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │   SQLite     │  │   文件系统    │  │   配置存储    │ │
│  │   (Sequelize)│  │  (图片/音乐)   │  │   (数据库)    │ │
│  └──────────────┘  └──────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────┘
```

### 3.2 技术栈选型

#### 3.2.1 前端技术栈
- **框架**：Vue 3.0+（Composition API）
- **语言**：TypeScript 5.0+
- **构建工具**：Vite 4.0+
- **3D引擎**：Three.js r150+
- **状态管理**：Pinia 2.0+
- **UI组件库**：Element Plus 2.0+
- **样式处理**：SCSS
- **Excel处理**：SheetJS (xlsx)
- **动画库**：GSAP 3.0+
- **音频控制**：HTML5 Audio API

#### 3.2.2 后端技术栈
- **运行环境**：Node.js 16.0+
- **Web框架**：Express 4.18+
- **语言**：TypeScript 5.0+
- **数据库**：SQLite 3.0+
- **ORM框架**：Sequelize 6.0+
- **实时通信**：WebSocket (ws)
- **文件上传**：Multer 1.4+
- **Excel处理**：xlsx
- **语音服务**：商汤ASR SDK、TTS服务

### 3.3 系统模块划分

```
3D抽奖系统
├── 前端模块
│   ├── 认证模块（Login.vue）
│   ├── 主界面模块（Home.vue）
│   │   ├── 3D渲染模块（three.ts）
│   │   ├── 抽奖控制模块
│   │   ├── 音乐控制模块
│   │   └── 语音识别模块（enhanced-asr.ts）
│   ├── 配置模块（PrizeConfig.vue）
│   │   ├── 人员配置（ParticipantPanel.vue）
│   │   ├── 奖品配置（PrizePanel.vue）
│   │   ├── 全局配置（ConfigPanel.vue）
│   │   ├── 文件管理（FilePanel.vue）
│   │   └── 帮助说明（HelpPanel.vue）
│   └── 状态管理（stores/）
│       ├── auth.ts（认证状态）
│       └── lottery.ts（抽奖状态）
│
└── 后端模块
    ├── 认证模块（routes/auth.ts）
    ├── 参与者管理（routes/participants.ts）
    ├── 奖项管理（routes/prizes.ts）
    ├── 抽奖核心（routes/lottery.ts）
    ├── 配置管理（routes/config.ts）
    ├── 文件管理（routes/files.ts）
    ├── 语音识别（routes/asr.ts）
    ├── 文本转语音（routes/tts.ts）
    ├── 查询服务（routes/query.ts）
    └── 数据模型（models/）
        ├── Participant.ts
        ├── Prize.ts
        └── Config.ts
```



## 4. 功能模块详细设计

### 4.1 用户认证模块

#### 4.1.1 功能描述
提供用户登录功能，验证用户身份后进入系统主界面。

#### 4.1.2 界面原型
- **登录页面**：
  - 居中布局的登录表单
  - 密码输入框（默认密码：123）
  - 登录按钮
  - 简洁美观的UI设计

#### 4.1.3 交互流程
1. 用户访问系统，自动跳转到登录页
2. 输入密码（默认：123）
3. 点击登录按钮
4. 后端验证密码
5. 验证成功，返回Token并跳转到主界面
6. 验证失败，显示错误提示

#### 4.1.4 技术实现
- 前端：Vue 3组件，Element Plus表单组件
- 后端：Express路由，JWT Token生成
- 存储：Token存储在localStorage

### 4.2 参与人员管理模块

#### 4.2.1 功能描述
管理参与抽奖的人员信息，支持Excel批量导入、权重设置、中奖记录查询和导出。

#### 4.2.2 核心功能

**4.2.2.1 Excel模板下载**
- 提供标准Excel模板下载
- 模板包含字段：姓名（必填）、二级部门（必填）、三级部门（可选）
- 支持.xlsx格式

**4.2.2.2 Excel文件上传**
- 支持.xlsx文件上传
- 格式校验：检查表头是否包含必需字段
- 数据解析：提取姓名、部门信息
- 权重计算：相同姓名重复出现时，权重自动累加
- 数据入库：批量插入数据库

**4.2.2.3 人员列表管理**
- 显示所有参与人员
- 显示字段：姓名、二级部门、三级部门、权重、中奖状态
- 支持筛选：全部人员、未中奖人员、已中奖人员
- 支持搜索：按姓名、部门搜索

**4.2.2.4 权重管理**
- 自动计算：相同姓名出现次数作为权重
- 权重显示：以标签形式显示，不同权重不同颜色
- 权重统计：显示权重分布情况
- 权重影响：权重越大，中奖概率越高

**4.2.2.5 中奖名单管理**
- 中奖记录查看：显示所有中奖记录
- 中奖信息：姓名、部门、奖项、中奖时间
- 导出功能：导出为Excel文件
- 导出字段：姓名、二级部门、三级部门、奖项名称、中奖时间

#### 4.2.3 界面原型
- **人员配置面板**：
  - 顶部操作区：下载模板、上传名单、清空名单按钮
  - 统计信息区：总人数、已中奖、未中奖、总权重
  - 权重分布卡片：显示各权重的人数分布
  - 标签页：全部人员、未中奖、已中奖、中奖名单
  - 数据表格：显示人员列表，支持排序、搜索

#### 4.2.4 数据模型
```typescript
Participant {
  id: number;              // 主键
  name: string;            // 姓名（必填）
  department2: string;     // 二级部门（必填）
  department3?: string;    // 三级部门（可选）
  weight: number;           // 权重（默认1，重复出现累加）
  isWinner: boolean;       // 是否已中奖
  prizeId?: number;        // 中奖奖项ID
  createdAt: Date;         // 创建时间
  updatedAt: Date;         // 更新时间
}
```

### 4.3 奖项与奖品配置模块

#### 4.3.1 功能描述
管理抽奖奖项和奖品信息，支持奖项创建、编辑、删除，奖品图片上传等功能。

#### 4.3.2 核心功能

**4.3.2.1 奖项管理**
- 创建奖项：添加新奖项
- 编辑奖项：修改奖项信息
- 删除奖项：删除不需要的奖项
- 排序功能：调整奖项顺序（上移、下移）

**4.3.2.2 奖项信息配置**
- **奖项名称**：如"一等奖"、"二等奖"、"特别奖"等
- **奖品名称**：如"iPhone 15"、"U盘"、"耳机"等
- **奖品数量**：该奖项总共抽取的人数（1-100）
- **奖品图片**：上传奖品缩略图，支持点击选择
- **单次抽取人数**：每次抽奖抽取的人数（1-10，默认3）
- **分批抽取配置**：支持自定义分批抽取方案
  - 例如：总共10人，可以配置为：第1批3人，第2批3人，第3批4人
  - 配置格式：数组，如[3, 3, 4]

**4.3.2.3 默认奖项初始化**
- 一键初始化默认奖项
- 默认包含：一等奖、二等奖、三等奖、超级大奖、特别奖
- 每个奖项有默认的奖品名称和数量

**4.3.2.4 临时抽奖创建**
- 支持快速创建临时抽奖奖项
- 通过语音指令或键盘快捷键创建
- 自动命名为"临时抽奖"
- 可设置抽取人数

#### 4.3.3 界面原型
- **奖品配置面板**：
  - 顶部操作区：添加奖项、初始化默认奖项、清空所有奖项
  - 奖项列表：卡片式展示所有奖项
  - 每个奖项卡片包含：
    - 排序按钮（上移、下移）
    - 奖品缩略图（可点击选择）
    - 奖项名称输入框（可编辑）
    - 奖品名称输入框（可编辑）
    - 数量选择器（可编辑）
    - 单次抽取人数配置
    - 分批抽取配置（高级选项）
    - 删除按钮

#### 4.3.4 数据模型
```typescript
Prize {
  id: number;                    // 主键
  name: string;                  // 奖项名称
  itemName: string;              // 奖品名称
  quantity: number;               // 奖品数量
  image?: string;                // 奖品图片URL
  singleDrawCount: number;        // 单次抽取人数（默认3）
  batchConfig?: number[];         // 分批抽取配置
  order: number;                  // 排序顺序
  createdAt: Date;                // 创建时间
  updatedAt: Date;                // 更新时间
}
```

### 4.4 3D抽奖主界面模块

#### 4.4.1 功能描述
提供沉浸式的3D抽奖体验，包括3D粒子系统、抽奖动画、中奖展示等功能。

#### 4.4.2 核心功能

**4.4.2.1 3D场景渲染**
- **技术实现**：基于Three.js的3D渲染引擎
- **场景元素**：
  - 3D球体：作为中心参考点
  - 标签卡片：每个参与者显示为一个3D标签卡片
  - 标签内容：姓名、二级部门、三级部门
  - 标签样式：半透明背景，可配置颜色和透明度
- **布局方式**：标签卡片围绕球体空间分布，类似卫星围绕星球

**4.4.2.2 交互控制**
- **鼠标左键拖拽**：旋转3D场景，改变视角
- **滚轮缩放**：改变摄像机距离，放大/缩小视图
- **双击鼠标**：重置视角到初始位置和缩放比例
- **自适应缩放**：窗口尺寸变化时自动调整场景大小

**4.4.2.3 抽奖动画流程**

**第一阶段：开始抽奖**
1. 用户点击"开始抽奖"按钮或按↑键/Enter键
2. 暂停背景音乐
3. 播放"抽奖音乐1"（激动节奏）
4. 3D场景开始快速旋转
5. 标签卡片围绕球体快速旋转，产生视觉冲击

**第二阶段：停止抽奖**
1. 用户点击"停止抽奖"按钮或按↑键/Enter键
2. 停止"抽奖音乐1"
3. 播放"抽奖音乐2"（揭晓音效）
4. 3D场景停止旋转
5. 执行抽奖算法，随机抽取指定数量的中奖者
6. 中奖标签飞出球体，移至屏幕正中间
7. 中奖标签横向并排高亮显示
8. 顶部显示中奖信息横幅

**4.4.2.4 中奖展示**
- **3D展示**：中奖者标签飞出并高亮显示
- **信息横幅**：顶部显示奖项名称、奖品名称、中奖者姓名
- **礼花特效**：中奖时播放礼花动画效果
- **背景特效**：支持多种背景特效（星域、粒子流、能量波等）

**4.4.2.5 奖项选择面板**
- 左侧可折叠的奖项选择面板
- 显示所有可用奖项
- 每个奖项卡片显示：
  - 奖品缩略图
  - 奖项名称
  - 奖品名称
  - 剩余数量/总数量
  - 下次抽取人数
- 已抽完的奖项显示为灰色，不可选择
- 点击奖项卡片选择要抽取的奖项

#### 4.4.3 界面原型
- **主界面布局**：
  - 左侧：奖项选择面板（可折叠）
  - 中间：3D抽奖场景（全屏）
  - 顶部：系统标题、中奖信息横幅
  - 底部：抽奖控制按钮（开始抽奖/停止抽奖/继续抽奖）
  - 右上角：配置按钮、语音识别按钮
  - 右下角：音乐控制按钮

#### 4.4.4 技术实现
- **3D渲染**：Three.js场景、相机、渲染器
- **标签创建**：CSS3DRenderer创建3D标签
- **动画控制**：GSAP动画库控制旋转和飞出动画
- **性能优化**：使用requestAnimationFrame，GPU加速

### 4.5 系统配置模块

#### 4.5.1 功能描述
管理系统全局配置，包括标题、背景、音乐、标签样式等。

#### 4.5.2 核心功能

**4.5.2.1 全局配置**
- **系统标题**：自定义主界面顶部显示的标题
- **背景图片**：上传自定义背景图片，支持预览
- **自动播放**：是否自动播放背景音乐

**4.5.2.2 音乐配置**
- **背景音乐**：选择背景音乐文件（.mp3），循环播放
- **抽奖音乐1**：选择抽奖开始时的音乐文件
- **抽奖音乐2**：选择中奖揭晓时的音乐文件
- **音量调节**：统一调节所有音乐的音量（0-1）

**4.5.2.3 标签样式配置**
- **背景颜色**：标签卡片背景颜色（RGB/HEX）
- **文字颜色**：标签文字颜色（RGB/HEX）
- **背景透明度**：标签背景透明度（0-1）

**4.5.2.4 特效配置**
- **特效类型**：选择背景特效类型
  - 星域特效
  - 粒子流特效
  - 能量波特效
  - 光束雨特效
  - 魔法粒子特效
  - 星空漩涡特效

#### 4.5.3 界面原型
- **全局配置面板**：
  - 系统标题输入框
  - 背景图片上传区域（支持预览）
  - 音乐文件选择器（背景音乐、抽奖音乐1、抽奖音乐2）
  - 音量滑块
  - 标签样式配置（颜色选择器、透明度滑块）
  - 特效类型选择器
  - 保存按钮

#### 4.5.4 数据模型
```typescript
Config {
  id: number;                    // 主键
  key: string;                   // 配置键
  value: string;                 // 配置值（JSON字符串）
  createdAt: Date;               // 创建时间
  updatedAt: Date;               // 更新时间
}

// 配置项示例
{
  title: "2025年度抽奖活动",
  backgroundImage: "/uploads/images/bg.jpg",
  backgroundMusic: "/uploads/music/bg.mp3",
  lotteryMusic1: "/uploads/music/draw1.mp3",
  lotteryMusic2: "/uploads/music/draw2.mp3",
  musicVolume: 0.7,
  autoPlay: true,
  labelBackgroundColor: "#ffffff",
  labelTextColor: "#333333",
  labelBackgroundOpacity: 0.8,
  effectType: "starfield"
}
```

### 4.6 文件管理模块

#### 4.6.1 功能描述
管理系统上传的文件，包括图片和音乐文件。

#### 4.6.2 核心功能
- **文件上传**：支持图片（.jpg, .png, .gif）和音乐（.mp3）文件上传
- **文件列表**：按类型分类显示已上传的文件
- **文件预览**：图片文件支持预览，音乐文件支持试听
- **文件删除**：删除不需要的文件
- **文件使用**：在配置中选择已上传的文件

#### 4.6.3 界面原型
- **文件管理面板**：
  - 标签页：图片文件、音乐文件
  - 上传区域：拖拽上传或点击上传
  - 文件列表：网格布局显示文件
  - 每个文件项：缩略图/图标、文件名、删除按钮

### 4.7 语音识别与控制模块

#### 4.7.1 功能描述
提供语音识别功能，支持唤醒词检测、语音指令识别和执行。

#### 4.7.2 核心功能

**4.7.2.1 唤醒词检测**
- **唤醒词**：支持自定义唤醒词（默认："小羊小羊"、"你好小羊"）
- **检测方式**：持续监听麦克风，检测是否说出唤醒词
- **反馈机制**：检测到唤醒词后，给出视觉反馈

**4.7.2.2 语音识别**
- **识别引擎**：Web Speech API（浏览器原生）
- **识别语言**：中文（zh-CN）
- **识别模式**：连续识别，检测静音后停止
- **静音检测**：检测到1.5秒静音后自动停止录音

**4.7.2.3 意图识别**
- **识别方式**：调用商汤大模型进行意图识别
- **支持的意图**：
  - 开始抽奖（"开始抽奖"、"开始"）
  - 停止抽奖（"停止抽奖"、"停止"）
  - 继续抽奖（"继续抽奖"、"继续"）
  - 显示结果（"显示结果"、"查看结果"）
  - 清空结果（"清空结果"、"重置"）
  - 下一个奖项（"下一个奖项"、"下一个"）
  - 查询奖项获奖者（"查询第一轮抽奖中奖者"）
  - 添加临时抽奖（"增加一轮抽奖"、"创建临时抽奖"）
  - 帮助（"帮助"、"使用说明"）

**4.7.2.4 指令执行**
- 根据识别出的意图，自动执行相应操作
- 支持参数提取（如：抽取人数、奖项名称）

**4.7.2.5 语音播报**
- 使用TTS（文本转语音）服务播报中奖结果
- 支持自定义播报内容

#### 4.7.3 界面原型
- **语音识别按钮**：
  - 位置：右下角（音乐控制按钮旁边）
  - 状态显示：
    - 未激活：灰色图标
    - 监听唤醒词：绿色图标，脉冲动画
    - 正在录音：红色图标，脉冲动画
    - 正在识别：黄色图标，加载动画

#### 4.7.4 技术实现
- **前端**：Web Speech API、唤醒词检测算法
- **后端**：商汤ASR SDK、意图识别服务、TTS服务
- **通信**：WebSocket实时通信

### 4.8 查询服务模块

#### 4.8.1 功能描述
提供抽奖结果查询功能，支持按奖项查询中奖者、查询剩余奖项等。

#### 4.8.2 核心功能
- **查询奖项获奖者**：根据奖项名称或ID查询中奖者列表
- **查询剩余奖项**：查询还有剩余名额的奖项
- **查询总剩余人数**：查询还未中奖的总人数
- **结果展示**：以弹窗或卡片形式展示查询结果
- **语音播报**：查询结果支持TTS语音播报

#### 4.8.3 界面原型
- **查询结果显示**：
  - 弹窗或浮动卡片
  - 显示奖项信息、中奖者列表、统计信息
  - 支持关闭和语音播报



## 5. 界面原型说明

### 5.1 登录界面

**布局设计**：
- 居中布局，简洁大方
- 渐变背景或自定义背景图
- 登录表单卡片，半透明毛玻璃效果

**元素组成**：
- 系统Logo/标题
- 密码输入框
- 登录按钮
- 提示信息（可选）

### 5.2 主界面（3D抽奖界面）

**布局设计**：
- 全屏布局，沉浸式体验
- 左侧可折叠的奖项选择面板
- 中间3D场景占据主要区域
- 顶部标题栏
- 底部控制按钮
- 右上角功能按钮

**元素组成**：
- **左侧面板**：
  - 奖项列表卡片
  - 每个卡片显示：图片、名称、剩余数量
- **3D场景**：
  - 3D球体和标签卡片
  - 背景特效
- **顶部横幅**：
  - 系统标题
  - 中奖信息横幅（抽奖后显示）
- **控制按钮**：
  - 开始抽奖/停止抽奖/继续抽奖
- **功能按钮**：
  - 配置按钮（右上角）
  - 语音识别按钮（右下角）
  - 音乐控制按钮（右下角）

### 5.3 配置界面

**布局设计**：
- 侧边栏导航 + 主内容区
- 标签页切换不同配置模块

**元素组成**：
- **左侧导航**：
  - 人员配置
  - 奖品配置
  - 全局配置
  - 文件管理
  - 操作说明
- **主内容区**：
  - 根据选择的导航项显示对应配置面板

### 5.4 人员配置面板

**元素组成**：
- 顶部操作栏：下载模板、上传名单、清空名单
- 统计信息区：总人数、已中奖、未中奖、总权重
- 权重分布卡片：显示权重分布情况
- 标签页：全部人员、未中奖、已中奖、中奖名单
- 数据表格：显示人员列表

### 5.5 奖品配置面板

**元素组成**：
- 顶部操作栏：添加奖项、初始化默认奖项、清空所有奖项
- 奖项列表：卡片式展示
- 每个卡片：排序按钮、图片、名称、数量等配置项

### 5.6 全局配置面板

**元素组成**：
- 系统标题输入框
- 背景图片上传
- 音乐文件选择
- 音量调节
- 标签样式配置
- 特效类型选择

## 6. 交互流程设计

### 6.1 用户登录流程

```
开始
  ↓
显示登录页面
  ↓
用户输入密码
  ↓
点击登录按钮
  ↓
发送登录请求
  ↓
验证密码
  ↓
[密码正确?]
  ├─ 是 → 生成Token → 跳转主界面
  └─ 否 → 显示错误提示 → 返回登录页面
```

### 6.2 参与人员导入流程

```
开始
  ↓
进入人员配置面板
  ↓
下载Excel模板
  ↓
填写人员信息
  ↓
上传Excel文件
  ↓
文件格式校验
  ↓
[格式正确?]
  ├─ 否 → 显示错误提示 → 返回
  └─ 是 → 解析Excel数据
         ↓
         计算权重
         ↓
         批量插入数据库
         ↓
         刷新人员列表
         ↓
         显示成功提示
```

### 6.3 抽奖流程

```
开始
  ↓
选择奖项（点击奖项卡片）
  ↓
点击"开始抽奖"按钮（或按↑键/Enter键）
  ↓
暂停背景音乐
  ↓
播放抽奖音乐1
  ↓
启动3D旋转动画
  ↓
[用户点击"停止抽奖"?]
  ├─ 否 → 继续旋转
  └─ 是 → 停止旋转动画
         ↓
         停止抽奖音乐1
         ↓
         播放抽奖音乐2
         ↓
         执行抽奖算法
         ↓
         标记中奖者
         ↓
         中奖标签飞出动画
         ↓
         显示中奖信息横幅
         ↓
         播放礼花特效
         ↓
         语音播报中奖结果（可选）
         ↓
         显示"继续抽奖"按钮
```

### 6.4 语音控制流程

```
开始
  ↓
点击语音识别按钮
  ↓
启动唤醒词监听
  ↓
[检测到唤醒词?]
  ├─ 否 → 继续监听
  └─ 是 → 开始录音
         ↓
         显示录音状态
         ↓
         [检测到静音?]
           ├─ 否 → 继续录音
           └─ 是 → 停止录音
                  ↓
                  发送语音到后端
                  ↓
                  意图识别
                  ↓
                  [识别成功?]
                    ├─ 否 → 显示识别失败
                    └─ 是 → 执行对应操作
                           ↓
                           显示执行结果
```

### 6.5 中奖结果导出流程

```
开始
  ↓
进入人员配置面板
  ↓
切换到"中奖名单"标签页
  ↓
点击"导出中奖名单"按钮
  ↓
后端查询所有中奖记录
  ↓
生成Excel文件
  ↓
返回文件下载链接
  ↓
浏览器下载文件
```



## 7. 数据模型设计

### 7.1 数据库设计

#### 7.1.1 参与者表（Participants）

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | INTEGER | PRIMARY KEY, AUTO_INCREMENT | 主键 |
| name | VARCHAR(100) | NOT NULL | 姓名 |
| department2 | VARCHAR(200) | NOT NULL | 二级部门 |
| department3 | VARCHAR(200) | NULL | 三级部门 |
| weight | INTEGER | DEFAULT 1 | 权重 |
| isWinner | BOOLEAN | DEFAULT false | 是否已中奖 |
| prizeId | INTEGER | NULL, FOREIGN KEY | 中奖奖项ID |
| createdAt | DATETIME | NOT NULL | 创建时间 |
| updatedAt | DATETIME | NOT NULL | 更新时间 |

#### 7.1.2 奖项表（Prizes）

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | INTEGER | PRIMARY KEY, AUTO_INCREMENT | 主键 |
| name | VARCHAR(100) | NOT NULL | 奖项名称 |
| itemName | VARCHAR(200) | NOT NULL | 奖品名称 |
| quantity | INTEGER | NOT NULL, DEFAULT 1 | 奖品数量 |
| image | VARCHAR(500) | NULL | 奖品图片URL |
| singleDrawCount | INTEGER | DEFAULT 3 | 单次抽取人数 |
| batchConfig | TEXT | NULL | 分批抽取配置（JSON） |
| order | INTEGER | DEFAULT 0 | 排序顺序 |
| createdAt | DATETIME | NOT NULL | 创建时间 |
| updatedAt | DATETIME | NOT NULL | 更新时间 |

#### 7.1.3 配置表（Configs）

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | INTEGER | PRIMARY KEY, AUTO_INCREMENT | 主键 |
| key | VARCHAR(100) | UNIQUE, NOT NULL | 配置键 |
| value | TEXT | NOT NULL | 配置值（JSON） |
| createdAt | DATETIME | NOT NULL | 创建时间 |
| updatedAt | DATETIME | NOT NULL | 更新时间 |

### 7.2 数据关系

```
Participants (参与者)
    ↓ (多对一)
Prizes (奖项)
    ↑
    └── 一个奖项可以有多个中奖者

Configs (配置)
    └── 独立表，存储系统配置
```

### 7.3 数据流转

```
Excel文件
  ↓ (解析)
参与者数据
  ↓ (插入)
数据库 Participants表
  ↓ (查询)
前端显示
  ↓ (抽奖)
中奖记录（更新isWinner、prizeId）
  ↓ (导出)
Excel文件
```



## 8. 技术实现方案

### 8.1 3D渲染实现

#### 8.1.1 Three.js场景搭建
```typescript
// 创建场景
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(75, width/height, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ alpha: true });

// 创建CSS3D渲染器用于标签
const css3DRenderer = new CSS3DRenderer();

// 创建球体布局
const sphereRadius = 200;
participants.forEach((participant, index) => {
  const phi = Math.acos(-1 + (2 * index) / participants.length);
  const theta = Math.sqrt(participants.length * Math.PI) * phi;
  
  const x = sphereRadius * Math.cos(theta) * Math.sin(phi);
  const y = sphereRadius * Math.sin(theta) * Math.sin(phi);
  const z = sphereRadius * Math.cos(phi);
  
  // 创建标签卡片
  const label = createLabelCard(participant);
  label.position.set(x, y, z);
  scene.add(label);
});
```

#### 8.1.2 标签卡片创建
```typescript
function createLabelCard(participant: Participant) {
  const div = document.createElement('div');
  div.className = 'participant-label';
  div.innerHTML = `
    <div class="label-content">
      <div class="name">${participant.name}</div>
      <div class="dept">${participant.department2}</div>
      ${participant.department3 ? `<div class="dept3">${participant.department3}</div>` : ''}
    </div>
  `;
  
  const object = new CSS3DObject(div);
  return object;
}
```

#### 8.1.3 旋转动画
```typescript
function startLotteryEffect() {
  const rotationSpeed = 0.02;
  
  function animate() {
    if (isRotating) {
      sphere.rotation.y += rotationSpeed;
      requestAnimationFrame(animate);
    }
  }
  animate();
}
```

#### 8.1.4 飞出动画
```typescript
function showWinners(winners: Participant[]) {
  winners.forEach((winner, index) => {
    const label = findLabelByParticipant(winner);
    if (label) {
      // 使用GSAP动画
      gsap.to(label.position, {
        x: (index - winners.length / 2) * 150,
        y: 0,
        z: 0,
        duration: 1,
        ease: "power2.out"
      });
      
      // 高亮效果
      label.element.style.transform = 'scale(1.5)';
      label.element.style.opacity = '1';
    }
  });
}
```

### 8.2 抽奖算法实现

#### 8.2.1 基于权重的随机选择
```typescript
function weightedRandomSelection(participants: Participant[], count: number): Participant[] {
  const winners: Participant[] = [];
  const available = [...participants];
  
  for (let i = 0; i < count && available.length > 0; i++) {
    // 计算总权重
    const totalWeight = available.reduce((sum, p) => sum + (p.weight || 1), 0);
    
    // 生成随机数
    const random = Math.random() * totalWeight;
    
    // 根据权重选择
    let currentWeight = 0;
    let selectedIndex = -1;
    
    for (let j = 0; j < available.length; j++) {
      currentWeight += available[j].weight || 1;
      if (random <= currentWeight) {
        selectedIndex = j;
        break;
      }
    }
    
    // 添加中奖者并移除
    winners.push(available[selectedIndex]);
    available.splice(selectedIndex, 1);
  }
  
  return winners;
}
```

### 8.3 WebSocket实时同步

#### 8.3.1 服务器端
```typescript
import { WebSocketServer } from 'ws';

const wss = new WebSocketServer({ server });

wss.on('connection', (ws) => {
  ws.on('message', (message) => {
    const data = JSON.parse(message.toString());
    
    // 广播给所有客户端
    wss.clients.forEach((client) => {
      if (client.readyState === WebSocket.OPEN) {
        client.send(JSON.stringify(data));
      }
    });
  });
});
```

#### 8.3.2 客户端
```typescript
const ws = new WebSocket('ws://localhost:3000/ws');

ws.onmessage = (event) => {
  const data = JSON.parse(event.data);
  
  if (data.type === 'lottery_start') {
    // 同步开始抽奖
    startLotteryAnimation();
  } else if (data.type === 'lottery_stop') {
    // 同步停止抽奖
    stopLotteryAnimation();
  }
};
```

### 8.4 Excel处理实现

#### 8.4.1 文件上传
```typescript
// 使用Multer处理文件上传
import multer from 'multer';

const upload = multer({ dest: 'uploads/' });

router.post('/upload', upload.single('file'), async (req, res) => {
  const file = req.file;
  // 解析Excel文件
  const workbook = XLSX.readFile(file.path);
  const sheet = workbook.Sheets[workbook.SheetNames[0]];
  const data = XLSX.utils.sheet_to_json(sheet);
  
  // 处理数据
  // ...
});
```

#### 8.4.2 文件导出
```typescript
function exportWinners(winners: Winner[]) {
  const ws = XLSX.utils.json_to_sheet(winners);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "中奖名单");
  
  XLSX.writeFile(wb, "中奖名单.xlsx");
}
```

### 8.5 语音识别实现

#### 8.5.1 唤醒词检测
```typescript
class WakeWordDetector {
  private recognition: SpeechRecognition;
  private wakeWords: string[] = ['小羊小羊', '你好小羊'];
  
  startListening() {
    this.recognition.continuous = true;
    this.recognition.interimResults = true;
    
    this.recognition.onresult = (event) => {
      const transcript = event.results[event.results.length - 1][0].transcript;
      
      // 检查是否包含唤醒词
      if (this.wakeWords.some(word => transcript.includes(word))) {
        this.onWakeWordDetected();
      }
    };
    
    this.recognition.start();
  }
}
```

#### 8.5.2 意图识别
```typescript
async function recognizeIntent(text: string) {
  const response = await fetch('/api/asr/test-intent', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ text })
  });
  
  const result = await response.json();
  return result.intent; // { intent: 'start_lottery', confidence: 0.95 }
}
```



## 9. 系统特色功能

### 9.1 3D可视化抽奖
- 基于Three.js的3D粒子系统
- 标签卡片环绕球体布局
- 流畅的旋转和飞出动画
- 支持鼠标交互控制

### 9.2 权重抽奖算法
- 支持参与者权重设置
- 相同姓名重复出现时权重自动累加
- 权重越大，中奖概率越高
- 公平透明的抽奖机制

### 9.3 语音控制
- 唤醒词检测
- 语音指令识别
- 意图理解与执行
- 语音播报中奖结果

### 9.4 实时同步
- WebSocket多客户端同步
- 多个浏览器窗口同步抽奖状态
- 适用于大屏幕展示场景

### 9.5 灵活的奖项配置
- 支持自定义分批抽取
- 临时抽奖快速创建
- 奖项排序和编辑
- 奖品图片上传

### 9.6 丰富的视觉效果
- 多种背景特效可选
- 礼花动画效果
- 标签样式自定义
- 流畅的动画过渡

### 9.7 完善的导出功能
- Excel格式导出
- 中奖名单完整记录
- 支持数据统计分析



## 10. 部署与运行方案

### 10.1 环境要求

- **Node.js**: >= 16.0.0
- **npm**: >= 8.0.0
- **现代浏览器**: Chrome 90+, Firefox 88+, Safari 14+, Edge 90+
- **操作系统**: Windows 10+, macOS 10.15+, Linux

### 10.2 安装步骤

#### 10.2.1 安装依赖
```bash
# 安装根目录依赖
npm install

# 安装前端依赖
cd frontend
npm install

# 安装后端依赖
cd ../backend
npm install
```

#### 10.2.2 配置环境变量
创建 `backend/.env` 文件：
```env
NODE_ENV=development
PORT=3000
DB_NAME=lottery.db
DB_PATH=./database/
CORS_ORIGIN=http://localhost:5173
UPLOAD_DIR=./uploads
MAX_FILE_SIZE=10485760
JWT_SECRET=your-secret-key-here
DEFAULT_PASSWORD=123
```

#### 10.2.3 启动服务
```bash
# Windows一键启动
start.bat

# 或手动启动
npm run dev
```

### 10.3 访问地址

- **前端地址**: http://localhost:5173
- **后端API**: http://localhost:3000
- **WebSocket**: ws://localhost:3000/ws

### 10.4 生产部署

#### 10.4.1 构建前端
```bash
cd frontend
npm run build
```

#### 10.4.2 构建后端
```bash
cd backend
npm run build
npm start
```

#### 10.4.3 使用PM2管理进程
```bash
pm2 start backend/dist/app.js --name lottery-backend
pm2 start frontend/dist --name lottery-frontend
```



## 11. 总结

### 11.1 系统特点

本3D抽奖系统严格按照用户需求设计实现，具有以下特点：

1. **功能完整**：涵盖抽奖全流程，从人员导入到结果导出
2. **体验优秀**：3D可视化、流畅动画、丰富特效
3. **操作便捷**：Excel批量导入、语音控制、键盘快捷键
4. **技术先进**：Vue 3、TypeScript、Three.js等现代技术栈
5. **扩展性强**：模块化设计，易于扩展新功能

### 11.2 满足需求情况

✅ **用户认证**：登录功能完整实现  
✅ **人员管理**：Excel导入导出、权重管理完整实现  
✅ **奖项配置**：奖项创建、编辑、删除完整实现  
✅ **3D抽奖**：3D场景、动画、交互完整实现  
✅ **系统配置**：标题、背景、音乐配置完整实现  
✅ **语音控制**：语音识别、意图识别、指令执行完整实现  
✅ **结果管理**：中奖记录查询、导出完整实现  

### 11.3 创新亮点

1. **3D可视化**：首次将Three.js应用于抽奖系统，提供沉浸式体验
2. **权重算法**：支持权重设置，实现公平透明的抽奖机制
3. **语音控制**：集成语音识别和意图理解，提升操作便捷性
4. **实时同步**：WebSocket多客户端同步，适用于大屏幕展示
5. **灵活配置**：支持分批抽取、临时抽奖等灵活配置



## 附录

### A. 键盘快捷键说明

| 快捷键 | 功能 |
|--------|------|
| ↑ | 开始抽奖/停止抽奖/继续抽奖 |
| Enter | 开始抽奖/停止抽奖/继续抽奖 |
| ← | 隐藏奖项选择面板 |
| → | 显示奖项选择面板 |
| PageUp | 选择上一个奖项 |
| PageDown | 选择下一个奖项 |
| Space | 开始/停止语音录音 |
| ↓ | 开始/停止语音录音 |
| Backspace | 返回主页面 |
| Delete | 重置默认奖项 |
| 1-9 | 创建临时抽奖（抽取对应人数） |
| Q | 查询第一轮抽奖中奖者 |
| W | 查询第二轮抽奖中奖者 |
| E | 查询第三轮抽奖中奖者 |
| R/T/Y/U/I | 查询第1-5次临时抽奖中奖者 |

### B. 语音指令说明

| 语音指令 | 功能 |
|----------|------|
| "开始抽奖" | 开始抽奖动画 |
| "停止抽奖" | 停止抽奖并抽取中奖者 |
| "继续抽奖" | 继续当前奖项或切换下一个 |
| "显示结果" | 显示中奖名单 |
| "清空结果" | 清空所有抽奖结果 |
| "下一个奖项" | 切换到下一个奖项 |
| "查询第一轮抽奖中奖者" | 查询指定奖项的中奖情况 |
| "增加一轮抽奖" | 创建临时抽奖 |
| "帮助" | 显示帮助信息 |

### C. API接口文档

#### C.1 认证接口
- `POST /api/auth/login` - 用户登录

#### C.2 参与者管理
- `GET /api/participants` - 获取参与者列表
- `GET /api/participants/template` - 下载Excel模板
- `POST /api/participants/upload` - 上传参与者文件
- `GET /api/participants/winners` - 获取中奖名单
- `GET /api/participants/winners/export` - 导出中奖名单

#### C.3 奖项管理
- `GET /api/prizes` - 获取奖项列表
- `POST /api/prizes` - 创建奖项
- `PUT /api/prizes/:id` - 更新奖项
- `DELETE /api/prizes/:id` - 删除奖项
- `POST /api/prizes/init-default` - 初始化默认奖项

#### C.4 抽奖功能
- `POST /api/lottery/draw/:prizeId` - 开始抽奖
- `POST /api/lottery/reset` - 重置抽奖
- `GET /api/lottery/stats` - 获取统计信息

#### C.5 配置管理
- `GET /api/config` - 获取配置
- `PUT /api/config/:key` - 更新单个配置
- `PUT /api/config` - 批量更新配置

#### C.6 文件管理
- `POST /api/files/upload` - 上传文件
- `GET /api/files/list/:type` - 获取文件列表
- `DELETE /api/files/:type/:filename` - 删除文件

#### C.7 语音识别
- `POST /api/asr/test-intent` - 意图识别
- `GET /api/asr/intent-config` - 获取意图识别配置

#### C.8 查询服务
- `POST /api/query/prize-winners` - 查询奖项获奖者

